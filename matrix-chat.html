<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khan Academy - Dialogic Delivery | Singh</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --background: #ffffff;
            --foreground: #171717;
            --card: #ffffff;
            --border: #e4e4e7;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0a0a0a;
                --foreground: #ededed;
                --card: #0a0a0a;
                --border: #27272a;
            }
        }

        body {
            color: var(--foreground);
            background: var(--background);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        nav {
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        @media (prefers-color-scheme: dark) {
            nav {
                background: rgba(15, 23, 42, 0.95);
            }
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .nav-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 4rem;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--foreground);
            text-decoration: none;
        }

        /* Main Layout */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* Setup Panel */
        .setup-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 5rem;
        }

        .setup-panel h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--foreground);
        }

        .form-group select,
        .form-group input {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--background);
            color: var(--foreground);
            font-size: 0.875rem;
        }

        .form-group select:focus,
        .form-group input:focus {
            outline: none;
            border-color: var(--amber-500);
            ring: 2px;
            ring-color: var(--amber-500);
        }

        .btn-primary {
            width: 100%;
            padding: 0.75rem;
            background: var(--amber-500);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: var(--amber-600);
        }

        .btn-primary:disabled {
            background: var(--slate-400);
            cursor: not-allowed;
        }

        /* Chat Panel */
        .chat-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 8rem);
            min-height: 600px;
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.connected {
            background: rgba(34, 197, 94, 0.1);
            color: rgb(34, 197, 94);
        }

        .status-badge.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: rgb(239, 68, 68);
        }

        .status-badge.delivering {
            background: rgba(59, 130, 246, 0.1);
            color: rgb(59, 130, 246);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.faculty {
            flex-direction: row;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background: var(--amber-500);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: var(--slate-500);
        }

        .message-content {
            flex: 1;
            background: var(--slate-50);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            max-width: 80%;
        }

        @media (prefers-color-scheme: dark) {
            .message-content {
                background: var(--slate-800);
            }
        }

        .message.faculty .message-content {
            border-top-left-radius: 0.25rem;
        }

        .message.user .message-content {
            border-top-right-radius: 0.25rem;
            background: var(--amber-50);
        }

        @media (prefers-color-scheme: dark) {
            .message.user .message-content {
                background: rgba(245, 158, 11, 0.1);
            }
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .message-sender {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--slate-500);
        }

        .message-text {
            color: var(--foreground);
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.delivering .message-content {
            border-left: 3px solid var(--amber-500);
        }

        .message.paused .message-content {
            border-left: 3px solid var(--slate-400);
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--background);
            color: var(--foreground);
            font-size: 0.875rem;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--amber-500);
        }

        .btn-send {
            padding: 0.75rem 1.5rem;
            background: var(--amber-500);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-send:hover {
            background: var(--amber-600);
        }

        .btn-send:disabled {
            background: var(--slate-400);
            cursor: not-allowed;
        }

        .progress-bar {
            height: 4px;
            background: var(--slate-200);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--amber-500);
            transition: width 0.3s ease;
        }

        .typing-indicator {
            display: flex;
            gap: 0.25rem;
            padding: 0.5rem;
        }

        .typing-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            background: var(--slate-400);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="nav-content">
                <a href="/" class="nav-logo">
                    <span>Singh</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Setup Panel -->
        <div class="setup-panel">
            <h2>Setup</h2>
            
            <div class="form-group">
                <label for="courseSelect">Khan Academy Class</label>
                <select id="courseSelect">
                    <option value="">-- Select a class --</option>
                    <option value="algebra-basics-intro">Introduction to Algebra</option>
                </select>
            </div>

            <div class="form-group">
                <label for="facultySelect">a.Faculty Persona</label>
                <select id="facultySelect">
                    <option value="">-- Select a.Faculty --</option>
                </select>
            </div>

            <div class="form-group">
                <label for="matrixRoom">Matrix Room (optional)</label>
                <input type="text" id="matrixRoom" placeholder="#ka-algebra:matrix.inquiry.institute">
            </div>

            <button id="startBtn" class="btn-primary" disabled>Start Delivery</button>

            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="chat-panel">
            <div class="chat-header">
                <h2>Dialogic Delivery</h2>
                <span class="status-badge disconnected" id="statusBadge">Disconnected</span>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message faculty">
                    <div class="message-avatar">S</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-sender">Singh</span>
                            <span class="message-time">Now</span>
                        </div>
                        <div class="message-text">
                            Select a Khan Academy class and a.Faculty persona to begin dialogic delivery.
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-input-area">
                <textarea 
                    id="chatInput" 
                    class="chat-input" 
                    placeholder="Ask a question or type a message..."
                    rows="2"
                    disabled
                ></textarea>
                <button id="sendBtn" class="btn-send" disabled>Send</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const MATRIX_SERVER = 'https://matrix.inquiry.institute';
        const DIALOGIC_API = 'https://xougqdomkoisrxdnagcj.supabase.co/functions/v1/faculty';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvdWdxZG9ta29pc3J4ZG5hZ2NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjIwMTIsImV4cCI6MjA4MTUzODAxMn0.eA1vXG6UVI1AjUOXN7q3gTlSyPoDByuVehOcKPjHmvs';

        // State
        let currentCourse = null;
        let currentFaculty = null;
        let currentRoomId = null;
        let transcriptSegments = [];
        let currentSegmentIndex = 0;
        let isDelivering = false;
        let isPaused = false;
        let deliveryTimeout = null;
        let matrixPollInterval = null;
        let lastMatrixEventId = null;

        // DOM Elements
        const courseSelect = document.getElementById('courseSelect');
        const facultySelect = document.getElementById('facultySelect');
        const matrixRoomInput = document.getElementById('matrixRoom');
        const startBtn = document.getElementById('startBtn');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const statusBadge = document.getElementById('statusBadge');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // Load faculty list
        async function loadFaculty() {
            try {
                const response = await fetch('https://xougqdomkoisrxdnagcj.supabase.co/rest/v1/faculty?select=id,surname,given_name&active=eq.true&limit=50', {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const faculty = await response.json();
                    facultySelect.innerHTML = '<option value="">-- Select a.Faculty --</option>';
                    faculty.forEach(f => {
                        const name = `${f.given_name || ''} ${f.surname || ''}`.trim() || f.id;
                        const option = document.createElement('option');
                        option.value = f.id;
                        option.textContent = name;
                        facultySelect.appendChild(option);
                    });
                } else {
                    // Fallback to sample faculty
                    const sampleFaculty = [
                        { id: 'a.gauss', name: 'Carl Friedrich Gauss' },
                        { id: 'a.einstein', name: 'Albert Einstein' },
                        { id: 'a.plato', name: 'Plato' },
                        { id: 'a.shelley', name: 'Mary Shelley' }
                    ];
                    facultySelect.innerHTML = '<option value="">-- Select a.Faculty --</option>';
                    sampleFaculty.forEach(f => {
                        const option = document.createElement('option');
                        option.value = f.id;
                        option.textContent = f.name;
                        facultySelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load faculty:', error);
            }
        }

        // Load course transcript
        async function loadCourse(courseId) {
            try {
                const response = await fetch(`data/transcripts/processed/sample_dialogic_transcript.json`);
                if (!response.ok) throw new Error('Failed to load transcript');
                
                const transcript = await response.json();
                transcriptSegments = transcript.segments || [];
                currentSegmentIndex = 0;
                return transcript;
            } catch (error) {
                console.error('Failed to load course:', error);
                addMessage('system', 'Error loading course transcript. Using sample data.');
                // Use embedded sample data
                transcriptSegments = [
                    {
                        segment_id: 1,
                        text: "Welcome to algebra. Today we'll explore the fundamental concepts of variables and how they work.",
                        allows_questions: true,
                        pause_duration: 2000
                    },
                    {
                        segment_id: 2,
                        text: "A variable is a symbol, usually a letter, that represents a number we don't know yet.",
                        allows_questions: true,
                        pause_duration: 1500
                    }
                ];
                currentSegmentIndex = 0;
            }
        }

        // Matrix client (simplified polling)
        class MatrixClient {
            constructor(roomId) {
                this.roomId = roomId;
                this.pollInterval = null;
                this.lastEventId = null;
            }

            async connect() {
                // Start polling for messages
                this.pollInterval = setInterval(() => this.pollMessages(), 2000);
                return true;
            }

            async pollMessages() {
                try {
                    const url = `${MATRIX_SERVER}/_matrix/client/v3/rooms/${encodeURIComponent(this.roomId)}/messages?dir=b&limit=10`;
                    const response = await fetch(url, {
                        headers: { 'Accept': 'application/json' }
                    });

                    if (!response.ok) {
                        if (response.status === 403) {
                            console.warn('Matrix room requires authentication');
                            return;
                        }
                        return;
                    }

                    const data = await response.json();
                    const events = data.chunk || [];

                    for (const event of events) {
                        if (event.type === 'm.room.message' && 
                            event.content?.msgtype === 'm.text' &&
                            event.event_id !== this.lastEventId) {
                            
                            // Check if this is a user question (not from faculty bot)
                            if (!event.sender?.includes('@a.') && !event.sender?.includes('@singh:')) {
                                handleUserQuestion(event.content.body);
                            }
                            
                            this.lastEventId = event.event_id;
                        }
                    }
                } catch (error) {
                    console.error('Error polling Matrix:', error);
                }
            }

            async sendMessage(text) {
                try {
                    // For now, we'll add messages locally
                    // In production, this would send to Matrix via edge function
                    addMessage('faculty', text, currentFaculty);
                    return true;
                } catch (error) {
                    console.error('Error sending Matrix message:', error);
                    return false;
                }
            }

            disconnect() {
                if (this.pollInterval) {
                    clearInterval(this.pollInterval);
                    this.pollInterval = null;
                }
            }
        }

        let matrixClient = null;

        // Add message to chat
        function addMessage(type, text, sender = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'faculty' ? (sender ? sender.charAt(0).toUpperCase() : 'F') : 'U';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const header = document.createElement('div');
            header.className = 'message-header';
            
            const senderSpan = document.createElement('span');
            senderSpan.className = 'message-sender';
            senderSpan.textContent = sender || (type === 'faculty' ? 'a.Faculty' : 'You');
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'message-time';
            timeSpan.textContent = new Date().toLocaleTimeString();
            
            header.appendChild(senderSpan);
            header.appendChild(timeSpan);
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = text;
            
            content.appendChild(header);
            content.appendChild(textDiv);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle user questions
        async function handleUserQuestion(question) {
            if (!question || !question.trim()) return;
            
            // Pause delivery if active
            if (isDelivering) {
                isPaused = true;
                if (deliveryTimeout) {
                    clearTimeout(deliveryTimeout);
                    deliveryTimeout = null;
                }
                statusBadge.textContent = 'Paused - Answering';
                statusBadge.className = 'status-badge disconnected';
            }
            
            addMessage('user', question);
            
            // Show typing indicator
            const typingIndicator = addTypingIndicator();
            
            // Get response from dialogic API
            try {
                // Try multiple API formats
                let response = null;
                let answer = null;
                
                // Try faculty edge function format
                try {
                    response = await fetch(DIALOGIC_API, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            personaId: `faculty.${currentFaculty}`,
                            message: question,
                            conversationHistory: []
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        answer = data.reply || data.answer || data.response;
                    }
                } catch (e) {
                    console.warn('Faculty API failed, trying alternative:', e);
                }
                
                // Fallback: Try ask-faculty endpoint
                if (!answer) {
                    try {
                        const askResponse = await fetch(`https://xougqdomkoisrxdnagcj.supabase.co/functions/v1/ask-faculty`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({
                                faculty_id: currentFaculty,
                                question: question
                            })
                        });
                        
                        if (askResponse.ok) {
                            const askData = await askResponse.json();
                            answer = askData.answer || askData.response;
                        }
                    } catch (e) {
                        console.warn('Ask-faculty API failed:', e);
                    }
                }
                
                // Remove typing indicator
                removeTypingIndicator(typingIndicator);
                
                if (answer) {
                    addMessage('faculty', answer, currentFaculty);
                } else {
                    // Fallback response
                    addMessage('faculty', 'That\'s an excellent question. Let me think about how to explain that in the context of what we\'re learning. For now, let me continue with the lesson, and we can revisit this concept.', currentFaculty);
                }
            } catch (error) {
                console.error('Error getting faculty response:', error);
                removeTypingIndicator(typingIndicator);
                addMessage('faculty', 'Thank you for that question. Let me continue with the lesson, and we can explore that further.', currentFaculty);
            }
            
            // Resume after a pause (if delivery was active)
            if (isDelivering) {
                setTimeout(() => {
                    isPaused = false;
                    statusBadge.textContent = 'Delivering';
                    statusBadge.className = 'status-badge delivering';
                    continueDelivery();
                }, 2000);
            }
        }
        
        // Add typing indicator
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message faculty typing';
            typingDiv.id = 'typing-indicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = currentFaculty ? currentFaculty.charAt(0).toUpperCase() : 'F';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            content.appendChild(typingIndicator);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(content);
            
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            return typingDiv;
        }
        
        // Remove typing indicator
        function removeTypingIndicator(indicator) {
            if (indicator && indicator.parentNode) {
                indicator.parentNode.removeChild(indicator);
            }
        }

        // Deliver transcript segments
        async function deliverSegment() {
            if (currentSegmentIndex >= transcriptSegments.length) {
                isDelivering = false;
                statusBadge.textContent = 'Complete';
                statusBadge.className = 'status-badge connected';
                addMessage('system', 'Delivery complete!');
                return;
            }

            const segment = transcriptSegments[currentSegmentIndex];
            
            // Send to Matrix and display locally
            if (matrixClient) {
                await matrixClient.sendMessage(segment.text);
            } else {
                addMessage('faculty', segment.text, currentFaculty);
            }
            
            // Update progress
            const progress = ((currentSegmentIndex + 1) / transcriptSegments.length) * 100;
            progressFill.style.width = `${progress}%`;
            
            currentSegmentIndex++;
            
            // Continue to next segment after pause
            if (segment.allows_questions && !isPaused) {
                deliveryTimeout = setTimeout(() => {
                    if (!isPaused && isDelivering) {
                        continueDelivery();
                    }
                }, segment.pause_duration || 2000);
            } else if (!isPaused && isDelivering) {
                // Small delay before next segment for natural pacing
                deliveryTimeout = setTimeout(() => {
                    if (!isPaused && isDelivering) {
                        continueDelivery();
                    }
                }, 500);
            }
        }

        function continueDelivery() {
            if (isDelivering && !isPaused) {
                deliverSegment();
            }
        }

        // Start delivery
        async function startDelivery() {
            const courseId = courseSelect.value;
            const facultyId = facultySelect.value;
            const roomAlias = matrixRoomInput.value.trim();

            if (!courseId || !facultyId) {
                alert('Please select both a course and a.Faculty');
                return;
            }

            currentCourse = courseId;
            currentFaculty = facultyId;
            
            // Load transcript
            await loadCourse(courseId);
            
            // Connect to Matrix room
            if (roomAlias) {
                // Extract room ID from alias or use as-is
                const roomId = roomAlias.startsWith('#') 
                    ? roomAlias.replace('#', '').replace(':', '/')
                    : roomAlias;
                
                matrixClient = new MatrixClient(roomId);
                await matrixClient.connect();
                statusBadge.textContent = 'Connected';
                statusBadge.className = 'status-badge connected';
            } else {
                statusBadge.textContent = 'Local Mode';
                statusBadge.className = 'status-badge connected';
            }

            // Start delivery
            isDelivering = true;
            isPaused = false;
            statusBadge.textContent = 'Delivering';
            statusBadge.className = 'status-badge delivering';
            progressBar.style.display = 'block';
            
            addMessage('system', `Starting delivery of "${courseSelect.options[courseSelect.selectedIndex].text}" by ${facultySelect.options[facultySelect.selectedIndex].text}`);
            
            chatInput.disabled = false;
            sendBtn.disabled = false;
            
            deliverSegment();
        }

        // Event listeners
        courseSelect.addEventListener('change', () => {
            updateStartButton();
        });

        facultySelect.addEventListener('change', () => {
            updateStartButton();
        });

        function updateStartButton() {
            startBtn.disabled = !(courseSelect.value && facultySelect.value);
        }

        startBtn.addEventListener('click', startDelivery);

        sendBtn.addEventListener('click', () => {
            const question = chatInput.value.trim();
            if (question) {
                handleUserQuestion(question);
                chatInput.value = '';
            }
        });
        
        // Also handle questions from Matrix polling
        function checkForMatrixQuestions() {
            // This is handled in the MatrixClient.pollMessages() method
            // which calls handleUserQuestion() when it detects a user message
        }

        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBtn.click();
            }
        });

        // Initialize
        loadFaculty();
        updateStartButton();
    </script>
</body>
</html>
