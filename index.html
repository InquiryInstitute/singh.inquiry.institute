<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khan Academy Lectures - Inquiry Institute</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --background: #ffffff;
            --foreground: #171717;
            --card: #ffffff;
            --card-foreground: #171717;
            --primary: #171717;
            --primary-foreground: #ffffff;
            --secondary: #f4f4f5;
            --secondary-foreground: #171717;
            --muted: #f4f4f5;
            --muted-foreground: #71717a;
            --border: #e4e4e7;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --amber-400: #fbbf24;
            --indigo-500: #6366f1;
            --indigo-600: #4f46e5;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0a0a0a;
                --foreground: #ededed;
                --card: #0a0a0a;
                --card-foreground: #ededed;
                --secondary: #27272a;
                --secondary-foreground: #ededed;
                --muted: #27272a;
                --muted-foreground: #a1a1aa;
                --border: #27272a;
            }
        }

        body {
            color: var(--foreground);
            background: var(--background);
            font-family: 'EB Garamond', 'Georgia', serif;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header/Navigation */
        nav {
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        @media (prefers-color-scheme: dark) {
            nav {
                background: rgba(15, 23, 42, 0.95);
                border-bottom-color: var(--slate-700);
            }
        }

        .nav-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .nav-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 4rem;
            position: relative;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: var(--foreground);
            text-decoration: none;
        }

        .nav-logo img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        @media (prefers-color-scheme: dark) {
            .logo-light {
                display: none !important;
            }
            .logo-dark {
                display: block !important;
            }
        }

        @media (prefers-color-scheme: light) {
            .logo-light {
                display: block !important;
            }
            .logo-dark {
                display: none !important;
            }
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 1024px) {
            .nav-links .nav-link:not(.nav-cta) {
                display: none;
            }
        }

        .nav-link {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--slate-700);
            text-decoration: none;
            transition: color 0.2s;
        }

        @media (prefers-color-scheme: dark) {
            .nav-link {
                color: var(--slate-300);
            }
        }

        .nav-link:hover {
            color: var(--amber-600);
        }

        .nav-cta {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: var(--amber-500);
            color: white;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            text-decoration: none;
            transition: background 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .nav-cta:hover {
            background: var(--amber-600);
        }

        /* Main Content */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--foreground);
        }

        h2 {
            font-size: 1.875rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--foreground);
        }

        /* Lectures Section */
        .lectures-section {
            margin-top: 3rem;
        }

        .lectures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .lecture-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.2s;
            cursor: pointer;
        }

        .lecture-card:hover {
            border-color: var(--amber-500);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .lecture-card.selected {
            border-color: var(--amber-500);
            background: rgba(245, 158, 11, 0.05);
        }

        .lecture-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--foreground);
        }

        .lecture-meta {
            font-size: 0.875rem;
            color: var(--muted-foreground);
            margin-bottom: 1rem;
        }

        .faculty-selector {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .faculty-selector label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--foreground);
        }

        .faculty-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--background);
            color: var(--foreground);
            font-size: 0.875rem;
        }

        .faculty-select:focus {
            outline: none;
            border-color: var(--amber-500);
            ring: 2px;
            ring-color: var(--amber-500);
        }

        .auto-selected {
            background: rgba(245, 158, 11, 0.1);
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            color: var(--amber-600);
            margin-bottom: 0.5rem;
        }

        /* Playback Widget */
        .playback-widget {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .playback-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .play-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background: var(--amber-500);
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .play-btn:hover {
            background: var(--amber-600);
        }

        .play-btn:disabled {
            background: var(--slate-400);
            cursor: not-allowed;
        }

        .play-btn.playing {
            background: var(--indigo-600);
        }

        .playback-status {
            flex: 1;
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        .audio-player {
            width: 100%;
            margin-top: 0.5rem;
        }

        .generating {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--muted-foreground);
        }

        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--slate-300);
            border-top-color: var(--amber-500);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Lantern (Patronage) */
        .lantern-button {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 50;
            width: 3rem;
            height: 3rem;
            border-radius: 9999px;
            background: var(--amber-500);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .lantern-button:hover {
            background: var(--amber-600);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .lantern-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .lantern-panel {
            position: fixed;
            bottom: 5rem;
            left: 1.5rem;
            width: 20rem;
            max-height: 24rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 50;
            display: none;
            overflow: hidden;
        }

        .lantern-panel.open {
            display: flex;
            flex-direction: column;
        }

        .lantern-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lantern-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.2);
            z-index: 40;
            display: none;
        }

        .backdrop.open {
            display: block;
        }

        /* Candle (Feedback) */
        .candle-button {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 50;
            width: 3rem;
            height: 3rem;
            border-radius: 9999px;
            background: var(--indigo-500);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .candle-button:hover {
            background: var(--indigo-600);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .candle-button svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .candle-panel {
            position: fixed;
            bottom: 5rem;
            right: 1.5rem;
            width: 24rem;
            max-height: 80vh;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 50;
            display: none;
            flex-direction: column;
        }

        .candle-panel.open {
            display: flex;
        }

        .candle-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .candle-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .btn-close {
            background: none;
            border: none;
            color: var(--slate-400);
            cursor: pointer;
            padding: 0.25rem;
        }

        .btn-close:hover {
            color: var(--slate-600);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }

            .lectures-grid {
                grid-template-columns: 1fr;
            }

            .lantern-panel,
            .candle-panel {
                width: calc(100% - 3rem);
                left: 1.5rem;
                right: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav>
        <div class="nav-container">
            <div class="nav-content">
                <a href="https://inquiry.institute/" class="nav-logo">
                    <img src="https://inquiry.institute/logo.png" alt="Inquiry Institute" width="32" height="32" class="logo-light" />
                    <img src="https://inquiry.institute/logo-white.png" alt="Inquiry Institute" width="32" height="32" class="logo-dark" style="display: none;" />
                    <span>Inquiry Institute</span>
                </a>
                <div class="nav-links">
                    <a href="https://inquiry.institute/start-here" class="nav-link">Start Here</a>
                    <a href="https://inquiry.institute/about" class="nav-link">About</a>
                    <a href="https://inquiry.institute/support" class="nav-cta">Support</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <h1>Khan Academy Lectures</h1>
        <p style="font-size: 1.125rem; color: var(--muted-foreground); margin-bottom: 2rem;">
            Select lectures and assign aFaculty members to deliver them. Each lecture can be taught by a different aFaculty persona.
        </p>

        <!-- Lectures Section -->
        <section class="lectures-section" id="lectures">
            <h2>Available Lectures</h2>
            <div class="lectures-grid" id="lecturesGrid">
                <!-- Lectures will be populated by JavaScript -->
            </div>
        </section>
    </div>

    <!-- Lantern (Patronage) -->
    <button class="lantern-button" id="lanternBtn" aria-label="View patrons">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2v4M12 18v4M8 6h8M8 18h8"/>
            <rect x="6" y="6" width="12" height="12" rx="2"/>
            <path d="M12 8v4M10 10h4"/>
        </svg>
    </button>

    <div class="backdrop" id="lanternBackdrop"></div>
    <div class="lantern-panel" id="lanternPanel">
        <div class="lantern-header">
            <h3 style="font-size: 1.125rem; font-weight: 600;">Patrons</h3>
            <button class="btn-close" id="lanternClose">✕</button>
        </div>
        <div class="lantern-content">
            <p style="text-align: center; color: var(--muted-foreground); padding: 2rem;">
                No patrons yet. Be the first to support this project!
            </p>
            <a href="https://opencollective.com/inquiry-institute" 
               target="_blank" 
               rel="noopener noreferrer"
               style="display: block; text-align: center; padding: 0.75rem; background: var(--amber-500); color: white; border-radius: 0.5rem; text-decoration: none; font-weight: 600; margin-top: 1rem;">
                Support this Work →
            </a>
        </div>
    </div>

    <!-- Candle (Feedback) -->
    <button class="candle-button" id="candleBtn" aria-label="Provide feedback">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="10" y="18" width="4" height="4" rx="1"/>
            <rect x="9" y="8" width="6" height="10" rx="1"/>
            <path d="M12 4v4M11 6h2"/>
            <circle cx="12" cy="6" r="1.5" fill="currentColor"/>
        </svg>
    </button>

    <div class="backdrop" id="candleBackdrop"></div>
    <div class="candle-panel" id="candlePanel">
        <div class="candle-header">
            <h3 style="font-size: 1.125rem; font-weight: 600;">Feedback</h3>
            <button class="btn-close" id="candleClose">✕</button>
        </div>
        <div class="candle-content">
            <p style="font-size: 0.75rem; color: var(--muted-foreground); margin-bottom: 1rem;">
                Page: <span id="currentPath">/</span>
            </p>
            <div style="margin-bottom: 1rem;">
                <h4 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.75rem;">Create Feedback Issue</h4>
                <form id="feedbackForm" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <div>
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Title</label>
                        <input type="text" 
                               id="feedbackTitle" 
                               required
                               style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 0.875rem;"/>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Details (optional)</label>
                        <textarea id="feedbackBody" 
                                  rows="4"
                                  style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 0.5rem; font-size: 0.875rem; resize: vertical;"></textarea>
                    </div>
                    <button type="submit" 
                            style="padding: 0.625rem; background: var(--indigo-600); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                        Create Issue on GitHub
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://xougqdomkoisrxdnagcj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvdWdxZG9ta29pc3J4ZG5hZ2NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjIwMTIsImV4cCI6MjA4MTUzODAxMn0.eA1vXG6UVI1AjUOXN7q3gTlSyPoDByuVehOcKPjHmvs';

        // Sample lectures data (will be replaced with actual Khan Academy data)
        const lectures = [
            { id: 1, title: "Introduction to Algebra", subject: "Math", topic: "Algebra", duration: "10:30", youtubeId: "NybHckSEQBI", transcript: "Welcome to algebra. Today we'll explore the fundamental concepts..." },
            { id: 2, title: "Basic Geometry", subject: "Math", topic: "Geometry", duration: "15:45", youtubeId: "xZ6g1fX2Y7g", transcript: "Geometry is the study of shapes and space. Let's begin..." },
            { id: 3, title: "World War I", subject: "History", topic: "World History", duration: "20:15", youtubeId: "_XPZQ0LAlR4", transcript: "World War I, also known as the Great War, began in 1914..." },
            { id: 4, title: "Photosynthesis", subject: "Biology", topic: "Biology", duration: "12:20", youtubeId: "sQK3Yr4Sc_k", transcript: "Photosynthesis is the process by which plants convert light energy..." },
            { id: 5, title: "Newton's Laws", subject: "Physics", topic: "Physics", duration: "18:30", youtubeId: "kKKM8Y-u7ds", transcript: "Newton's laws of motion form the foundation of classical mechanics..." },
            { id: 6, title: "The Water Cycle", subject: "Earth Science", topic: "Earth Science", duration: "8:45", youtubeId: "al-do-HGuIk", transcript: "The water cycle describes the continuous movement of water..." },
        ];

        // Faculty data with expertise mapping and voice prompts
        // This will be loaded from Supabase, but we have defaults
        let faculty = [
            { 
                id: "shelley", 
                name: "Mary Shelley", 
                expertise: ["Science", "Literature", "Philosophy"],
                elevenlabs_voice_id: null,
                elevenlabs_voice_prompt: "A thoughtful, articulate female voice with a British accent, speaking with poetic elegance and scientific curiosity."
            },
            { 
                id: "darwin", 
                name: "Charles Darwin", 
                expertise: ["Biology", "Science", "Natural History"],
                elevenlabs_voice_id: null,
                elevenlabs_voice_prompt: "A scholarly male voice with a British accent, speaking with careful observation and scientific precision."
            },
            { 
                id: "einstein", 
                name: "Albert Einstein", 
                expertise: ["Physics", "Mathematics", "Philosophy"],
                elevenlabs_voice_id: null,
                elevenlabs_voice_prompt: "A thoughtful male voice with a German accent, speaking with intellectual depth and clarity."
            },
            { 
                id: "curie", 
                name: "Marie Curie", 
                expertise: ["Physics", "Chemistry", "Science"],
                elevenlabs_voice_id: null,
                elevenlabs_voice_prompt: "A determined female voice with a Polish-French accent, speaking with scientific rigor and passion."
            },
            { 
                id: "plato", 
                name: "Plato", 
                expertise: ["Philosophy", "Mathematics", "History"],
                elevenlabs_voice_id: null,
                elevenlabs_voice_prompt: "A wise, authoritative male voice with a classical Greek accent, speaking with philosophical depth."
            },
            { 
                id: "tesla", 
                name: "Nikola Tesla", 
                expertise: ["Physics", "Engineering", "Mathematics"],
                elevenlabs_voice_id: null,
                elevenlabs_voice_prompt: "An innovative male voice with a Serbian accent, speaking with technical precision and visionary insight."
            },
        ];

        // Subject to expertise mapping for automatic faculty selection
        const subjectExpertiseMap = {
            "Math": ["Mathematics", "Physics", "Engineering"],
            "Physics": ["Physics", "Mathematics", "Engineering"],
            "Biology": ["Biology", "Science", "Natural History"],
            "Chemistry": ["Chemistry", "Physics", "Science"],
            "History": ["History", "Philosophy"],
            "Earth Science": ["Science", "Natural History"],
            "Science": ["Science", "Physics", "Biology", "Chemistry"],
        };

        // Function to find best faculty for a lecture
        function findBestFaculty(lecture) {
            const subject = lecture.subject;
            const relevantExpertise = subjectExpertiseMap[subject] || [subject];
            
            // Score each faculty based on expertise match
            const scoredFaculty = faculty.map(f => {
                let score = 0;
                relevantExpertise.forEach(exp => {
                    if (f.expertise.some(e => e.toLowerCase().includes(exp.toLowerCase()))) {
                        score += 2;
                    }
                });
                // Bonus for exact subject match
                if (f.expertise.some(e => e.toLowerCase() === subject.toLowerCase())) {
                    score += 3;
                }
                return { ...f, score };
            });

            // Return faculty with highest score
            scoredFaculty.sort((a, b) => b.score - a.score);
            return scoredFaculty[0] || faculty[0];
        }

        // Load faculty from Supabase
        async function loadFacultyFromSupabase() {
            try {
                // Get Supabase credentials
                const supabaseUrl = 'https://xougqdomkoisrxdnagcj.supabase.co';
                const supabaseKey = localStorage.getItem('SUPABASE_KEY') || '';
                
                if (!supabaseKey) {
                    console.warn('Supabase key not found, using default faculty data');
                    return;
                }

                const response = await fetch(`${supabaseUrl}/rest/v1/faculty?select=id,surname,given_name,fields,elevenlabs_voice_id,elevenlabs_voice_prompt&active=eq.true`, {
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Map Supabase faculty to our format
                    faculty = data.map(f => ({
                        id: f.id,
                        name: `${f.given_name || ''} ${f.surname || ''}`.trim() || f.id,
                        expertise: f.fields || [],
                        elevenlabs_voice_id: f.elevenlabs_voice_id,
                        elevenlabs_voice_prompt: f.elevenlabs_voice_prompt
                    }));
                    console.log('Loaded faculty from Supabase:', faculty.length);
                }
            } catch (error) {
                console.error('Failed to load faculty from Supabase:', error);
            }
        }

        // Generate audio using Supabase Edge Function
        async function generateAudio(text, facultyName) {
            if (!SUPABASE_ANON_KEY) {
                throw new Error('Supabase key not set. Please set SUPABASE_ANON_KEY in localStorage.');
            }

            const response = await fetch(`${SUPABASE_URL}/functions/v1/text-to-speech`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    faculty_name: facultyName,
                    text: text
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || `Supabase function error: ${response.statusText}`);
            }

            const data = await response.json();
            
            // Convert base64 to blob
            const binaryString = atob(data.audio_base64);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return new Blob([bytes], { type: data.audio_format || 'audio/mpeg' });
        }

        // Render lectures
        async function renderLectures() {
            // Load faculty from Supabase first
            await loadFacultyFromSupabase();
            
            const grid = document.getElementById('lecturesGrid');
            grid.innerHTML = lectures.map(lecture => {
                // Auto-select best faculty
                const bestFaculty = findBestFaculty(lecture);
                const audioId = `audio-${lecture.id}`;
                
                return `
                <div class="lecture-card" data-lecture-id="${lecture.id}">
                    <div class="lecture-title">${lecture.title}</div>
                    <div class="lecture-meta">
                        ${lecture.subject} • ${lecture.topic} • ${lecture.duration}
                    </div>
                    <div class="auto-selected">
                        ✨ Recommended: ${bestFaculty.name}
                    </div>
                    <div class="faculty-selector">
                        <label>Select Faculty:</label>
                        <select class="faculty-select" data-lecture-id="${lecture.id}">
                            <option value="">-- Choose faculty --</option>
                            ${faculty.map(f => `
                                <option value="${f.id}" ${f.id === bestFaculty.id ? 'selected' : ''}>${f.name}</option>
                            `).join('')}
                        </select>
                    </div>
                    <div class="playback-widget">
                        <div class="playback-controls">
                            <button class="play-btn" data-lecture-id="${lecture.id}" id="play-${lecture.id}" aria-label="Play lecture">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </button>
                            <div class="playback-status" id="status-${lecture.id}">Ready to generate</div>
                        </div>
                        <audio id="${audioId}" style="display: none;"></audio>
                    </div>
                </div>
            `;
            }).join('');

            // Add event listeners for faculty selection
            document.querySelectorAll('.faculty-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const lectureId = parseInt(e.target.dataset.lectureId);
                    const facultyId = e.target.value;
                    const card = e.target.closest('.lecture-card');
                    
                    if (facultyId) {
                        card.classList.add('selected');
                        const selectedFaculty = faculty.find(f => f.id === facultyId);
                        console.log(`Lecture "${lectures.find(l => l.id === lectureId).title}" assigned to ${selectedFaculty.name}`);
                    } else {
                        card.classList.remove('selected');
                    }
                });
            });

            // Add event listeners for playback
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const lectureId = parseInt(e.target.closest('.play-btn').dataset.lectureId);
                    await handlePlayback(lectureId);
                });
            });
        }

        // Handle audio playback
        async function handlePlayback(lectureId) {
            const lecture = lectures.find(l => l.id === lectureId);
            if (!lecture) return;

            const card = document.querySelector(`[data-lecture-id="${lectureId}"]`);
            const select = card.querySelector('.faculty-select');
            const facultyId = select.value;
            
            if (!facultyId) {
                alert('Please select a faculty member first');
                return;
            }

            const selectedFaculty = faculty.find(f => f.id === facultyId);
            const playBtn = document.getElementById(`play-${lectureId}`);
            const statusEl = document.getElementById(`status-${lectureId}`);
            const audioEl = document.getElementById(`audio-${lectureId}`);

            try {
                // Check if audio already generated
                const cachedAudioUrl = localStorage.getItem(`audio-${lectureId}-${facultyId}`);
                
                if (cachedAudioUrl && cachedAudioUrl.startsWith('blob:')) {
                    // Use cached audio
                    audioEl.src = cachedAudioUrl;
                    audioEl.play();
                    playBtn.classList.add('playing');
                    playBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
                    statusEl.textContent = `Playing: ${selectedFaculty.name}`;
                    return;
                }

                // Generate new audio
                playBtn.disabled = true;
                statusEl.innerHTML = '<div class="generating"><div class="spinner"></div> Generating audio...</div>';
                
                const audioBlob = await generateAudio(
                    lecture.transcript || `Welcome to ${lecture.title}. Today we'll explore ${lecture.topic}.`,
                    selectedFaculty.name
                );

                // Create audio URL and play
                const audioUrl = URL.createObjectURL(audioBlob);
                localStorage.setItem(`audio-${lectureId}-${facultyId}`, audioUrl);
                audioEl.src = audioUrl;
                audioEl.play();
                
                playBtn.disabled = false;
                playBtn.classList.add('playing');
                playBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
                statusEl.textContent = `Playing: ${selectedFaculty.name}`;

                // Handle audio end
                audioEl.onended = () => {
                    playBtn.classList.remove('playing');
                    playBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                    statusEl.textContent = 'Ready to play again';
                };

                // Handle pause
                audioEl.onpause = () => {
                    playBtn.classList.remove('playing');
                    playBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>';
                };

            } catch (error) {
                console.error('Error generating audio:', error);
                statusEl.textContent = `Error: ${error.message}`;
                playBtn.disabled = false;
            }
        }

        // Lantern functionality
        const lanternBtn = document.getElementById('lanternBtn');
        const lanternPanel = document.getElementById('lanternPanel');
        const lanternBackdrop = document.getElementById('lanternBackdrop');
        const lanternClose = document.getElementById('lanternClose');

        function toggleLantern() {
            const isOpen = lanternPanel.classList.contains('open');
            lanternPanel.classList.toggle('open');
            lanternBackdrop.classList.toggle('open');
        }

        lanternBtn.addEventListener('click', toggleLantern);
        lanternClose.addEventListener('click', toggleLantern);
        lanternBackdrop.addEventListener('click', toggleLantern);

        // Candle functionality
        const candleBtn = document.getElementById('candleBtn');
        const candlePanel = document.getElementById('candlePanel');
        const candleBackdrop = document.getElementById('candleBackdrop');
        const candleClose = document.getElementById('candleClose');
        const feedbackForm = document.getElementById('feedbackForm');
        const currentPath = document.getElementById('currentPath');

        currentPath.textContent = window.location.pathname;

        function toggleCandle() {
            const isOpen = candlePanel.classList.contains('open');
            candlePanel.classList.toggle('open');
            candleBackdrop.classList.toggle('open');
        }

        candleBtn.addEventListener('click', toggleCandle);
        candleClose.addEventListener('click', toggleCandle);
        candleBackdrop.addEventListener('click', toggleCandle);

        feedbackForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('feedbackTitle').value;
            const body = document.getElementById('feedbackBody').value;
            const path = window.location.pathname;
            
            // Create GitHub issue URL
            const issueTitle = encodeURIComponent(title);
            const issueBody = encodeURIComponent(`Feedback for page: ${path}\n\n${body}`);
            const issueUrl = `https://github.com/InquiryInstitute/singh.inquiry.institute/issues/new?title=${issueTitle}&body=${issueBody}&labels=feedback,user-reported`;
            
            window.open(issueUrl, '_blank');
            feedbackForm.reset();
            toggleCandle();
        });

        // Supabase key is set above, no need to prompt

        // Initialize
        renderLectures();
    </script>
</body>
</html>
