---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Dialogic Matrix Chat Delivery - Singh">
  <div class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Setup Panel -->
    <div class="lg:col-span-1">
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-6 sticky top-20">
        <h2 class="text-2xl font-semibold mb-6">Setup</h2>
        
        <div class="mb-4">
          <label for="courseSelect" class="block text-sm font-medium mb-2">Khan Academy Class</label>
          <select id="courseSelect" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900">
            <option value="">-- Select a class --</option>
            <option value="algebra-basics-intro">Introduction to Algebra</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="facultySelect" class="block text-sm font-medium mb-2">a.Faculty Persona</label>
          <select id="facultySelect" class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900">
            <option value="">-- Select a.Faculty --</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="matrixRoom" class="block text-sm font-medium mb-2">Matrix Room (optional)</label>
          <input 
            type="text" 
            id="matrixRoom" 
            placeholder="#ka-algebra:matrix.inquiry.institute"
            class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900"
          >
        </div>

        <button 
          id="startBtn" 
          class="w-full px-4 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-semibold transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed"
          disabled
        >
          Start Delivery
        </button>

        <div id="progressBar" class="hidden mt-4 h-1 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
          <div id="progressFill" class="h-full bg-amber-500 transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Chat Panel -->
    <div class="lg:col-span-2">
      <!-- Faculty Portrait Display - Above Chat -->
      <div id="facultyPortrait" class="mb-4 hidden">
        <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-4">
          <div class="flex items-center gap-4">
            <img 
              id="facultyPortraitImg" 
              src="" 
              alt="Faculty portrait" 
              class="w-24 h-24 rounded-lg object-cover border-2 border-amber-500 shadow-md"
              onerror="this.src='https://inquiry.institute/inquisitors/portraits/a-plato.jpg'"
            />
            <div class="flex-1">
              <div id="facultyPortraitName" class="text-xl font-semibold text-slate-900 dark:text-slate-100 mb-1"></div>
              <div id="facultyPortraitDiscipline" class="text-sm text-slate-600 dark:text-slate-400"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg flex flex-col" style="height: calc(100vh - 8rem); min-height: 600px;">
        <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center">
          <h2 class="text-xl font-semibold">Dialogic Delivery</h2>
          <span id="statusBadge" class="px-3 py-1 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400">
            Disconnected
          </span>
        </div>

        <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
          <div class="flex gap-3" data-message-id="welcome">
            <img 
              src="https://inquiry.institute/inquisitors/portraits/a-plato.jpg" 
              alt="Singh" 
              class="w-10 h-10 rounded-lg object-cover border-2 border-amber-500 flex-shrink-0"
              onerror="this.src='https://inquiry.institute/inquisitors/portraits/a-plato.jpg'"
            />
            <div class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-4 max-w-[80%]">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-semibold">Singh</span>
                <span class="text-xs text-slate-500">Now</span>
              </div>
              <div class="text-slate-900 dark:text-slate-100">
                Select a Khan Academy class and a.Faculty persona to begin dialogic delivery.
              </div>
            </div>
          </div>
        </div>

        <div class="px-6 py-4 border-t border-slate-200 dark:border-slate-700">
          <!-- Reply indicator -->
          <div id="replyIndicator" class="hidden mb-2 p-2 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg flex justify-between items-center">
            <div class="text-sm text-slate-700 dark:text-slate-300">
              <span class="font-semibold">â†© Replying to:</span>
              <span id="replyText" class="ml-2"></span>
            </div>
            <button 
              id="cancelReply" 
              class="text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"
              onclick="clearReply()"
            >
              Cancel
            </button>
          </div>
          
          <div class="flex gap-3">
            <textarea 
              id="chatInput" 
              class="flex-1 px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-900 resize-none"
              placeholder="Ask a question or type a message..."
              rows="2"
              disabled
            ></textarea>
            <button 
              id="sendBtn" 
              class="px-6 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg font-semibold transition-colors disabled:bg-slate-400 disabled:cursor-not-allowed"
              disabled
            >
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load dialogic library - will be loaded when needed
    let Dialogic, DialogicAPI;
    
    async function loadDialogic() {
      if (!Dialogic) {
        const module = await import('https://cdn.jsdelivr.net/gh/InquiryInstitute/dialogic@main/src/index.js');
        Dialogic = module.Dialogic;
        DialogicAPI = module.DialogicAPI;
      }
      return { Dialogic, DialogicAPI };
    }

    // Configuration
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhvdWdxZG9ta29pc3J4ZG5hZ2NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjIwMTIsImV4cCI6MjA4MTUzODAxMn0.eA1vXG6UVI1AjUOXN7q3gTlSyPoDByuVehOcKPjHmvs';
    
    // State
    let dialogic = null;
    let currentCourse = null;
    let currentFaculty = null;
    let transcriptSegments = [];

    // DOM Elements
    const courseSelect = document.getElementById('courseSelect');
    const facultySelect = document.getElementById('facultySelect');
    const matrixRoomInput = document.getElementById('matrixRoom');
    const startBtn = document.getElementById('startBtn');
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const statusBadge = document.getElementById('statusBadge');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const facultyPortrait = document.getElementById('facultyPortrait');
    const facultyPortraitImg = document.getElementById('facultyPortraitImg');
    const facultyPortraitName = document.getElementById('facultyPortraitName');
    const facultyPortraitDiscipline = document.getElementById('facultyPortraitDiscipline');

    // Cache for faculty portraits from Supabase
    const portraitCache = new Map();

    // Get portrait URL for faculty slug from Supabase
    async function getPortraitUrl(slug) {
      if (!slug) return 'https://inquiry.institute/inquisitors/portraits/a-plato.jpg';
      
      // Check cache first
      if (portraitCache.has(slug)) {
        const cached = portraitCache.get(slug);
        return cached || 'https://inquiry.institute/inquisitors/portraits/a-plato.jpg';
      }

      try {
        // Fetch from Supabase
        const response = await fetch(
          `https://xougqdomkoisrxdnagcj.supabase.co/rest/v1/faculty?select=id,portrait_url&id=eq.${encodeURIComponent(slug)}&limit=1`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );

        if (response.ok) {
          const data = await response.json();
          if (data && data.length > 0 && data[0].portrait_url) {
            const portraitUrl = data[0].portrait_url;
            portraitCache.set(slug, portraitUrl);
            return portraitUrl;
          }
        }
      } catch (error) {
        // Silently fail - we'll use GCS fallback
        // Network errors are expected in some environments, so we don't log them
        // Only log unexpected errors
        if (error && error.message) {
          const errorMsg = error.message;
          if (!errorMsg.includes('Failed to fetch') && !errorMsg.includes('ERR_NAME_NOT_RESOLVED')) {
            console.warn('Failed to fetch portrait from Supabase:', error);
          }
        }
      }

      // Fallback: try GCS
      const portraitSlug = slug.startsWith('a.') 
        ? slug.replace(/^a\./, 'a-').replace(/\./g, '-')
        : slug.startsWith('a-')
        ? slug
        : `a-${slug.replace(/\./g, '-')}`;
      
      const fallbackUrl = `https://storage.googleapis.com/afaculty/portraits/${portraitSlug}.jpg`;
      portraitCache.set(slug, fallbackUrl);
      return fallbackUrl;
    }

    // Update faculty portrait display
    async function updateFacultyPortrait(facultyId, facultyName, discipline) {
      if (!facultyId || !facultyPortrait) return;
      
      const portraitUrl = await getPortraitUrl(facultyId);
      
      if (facultyPortraitImg) {
        facultyPortraitImg.src = portraitUrl;
        facultyPortraitImg.alt = `${facultyName} portrait`;
      }
      
      if (facultyPortraitName) {
        facultyPortraitName.textContent = facultyName;
      }
      
      if (facultyPortraitDiscipline) {
        facultyPortraitDiscipline.textContent = discipline || '';
      }
      
      facultyPortrait.classList.remove('hidden');
    }

    // Load faculty list
    async function loadFaculty() {
      const { DialogicAPI: API } = await loadDialogic();
      const api = new API({
        apiUrl: 'https://xougqdomkoisrxdnagcj.supabase.co/functions/v1',
        apiKey: SUPABASE_ANON_KEY
      });

      try {
        // Fetch faculty with portrait URLs from Supabase
        const response = await fetch(
          'https://xougqdomkoisrxdnagcj.supabase.co/rest/v1/faculty?select=id,surname,given_name,fields,portrait_url&active=eq.true&limit=50',
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );

        if (response.ok) {
          const faculty = await response.json();
          if (faculty && faculty.length > 0) {
            facultySelect.innerHTML = '<option value="">-- Select a.Faculty --</option>';
            faculty.forEach(f => {
              const name = `${f.given_name || ''} ${f.surname || ''}`.trim() || f.id;
              const option = document.createElement('option');
              option.value = f.id;
              option.textContent = `${name}${f.fields && f.fields.length > 0 ? ` (${f.fields.join(', ')})` : ''}`;
              option.dataset.discipline = f.fields?.join(', ') || '';
              // Cache portrait URL if available
              if (f.portrait_url) {
                portraitCache.set(f.id, f.portrait_url);
              }
              facultySelect.appendChild(option);
            });
            return; // Success, exit early
          }
        }
      } catch (error) {
        // Silently fail and use fallback - network errors are expected in some environments
        // Only log unexpected errors
        if (error && error.message) {
          const errorMsg = error.message;
          if (!errorMsg.includes('Failed to fetch') && !errorMsg.includes('ERR_NAME_NOT_RESOLVED')) {
            console.warn('Failed to load faculty from Supabase (using fallback):', error);
          }
        }
      }
      
      // Fallback to hardcoded list (always available)
      // Comprehensive faculty list for Khan Academy content
      const sampleFaculty = [
          // Mathematics
          { id: 'a.gauss', name: 'Carl Friedrich Gauss', discipline: 'Mathematics' },
          { id: 'a.euler', name: 'Leonhard Euler', discipline: 'Mathematics' },
          { id: 'a.hypatia', name: 'Hypatia', discipline: 'Mathematics' },
          { id: 'a.plato', name: 'Plato', discipline: 'Mathematics & Philosophy' },
          { id: 'a.cantor', name: 'Georg Cantor', discipline: 'Mathematics' },
          { id: 'a.ramanujan', name: 'Srinivasa Ramanujan', discipline: 'Mathematics' },
          
          // Physics
          { id: 'a.einstein', name: 'Albert Einstein', discipline: 'Physics' },
          { id: 'a.newton', name: 'Isaac Newton', discipline: 'Physics & Mathematics' },
          { id: 'a.tesla', name: 'Nikola Tesla', discipline: 'Physics & Engineering' },
          { id: 'a.curie', name: 'Marie Curie', discipline: 'Physics & Chemistry' },
          { id: 'a.feynman', name: 'Richard Feynman', discipline: 'Physics' },
          { id: 'a.hawking', name: 'Stephen Hawking', discipline: 'Physics' },
          
          // Chemistry
          { id: 'a.mendeleev', name: 'Dmitri Mendeleev', discipline: 'Chemistry' },
          { id: 'a.lavoisier', name: 'Antoine Lavoisier', discipline: 'Chemistry' },
          
          // Biology
          { id: 'a.darwin', name: 'Charles Darwin', discipline: 'Biology' },
          { id: 'a.franklin', name: 'Rosalind Franklin', discipline: 'Biology' },
          
          // History
          { id: 'a.gibbon', name: 'Edward Gibbon', discipline: 'History' },
          { id: 'a.toynbee', name: 'Arnold Toynbee', discipline: 'History' },
          
          // Literature & Philosophy
          { id: 'a.shelley', name: 'Mary Shelley', discipline: 'Literature & Science' },
          { id: 'a.woolf', name: 'Virginia Woolf', discipline: 'Literature' },
          { id: 'a.nietzsche', name: 'Friedrich Nietzsche', discipline: 'Philosophy' },
          { id: 'a.steiner', name: 'Rudolf Steiner', discipline: 'Philosophy & Education' },
          
          // Arts & Interdisciplinary
          { id: 'a.davinci', name: 'Leonardo da Vinci', discipline: 'Art & Science' },
          { id: 'a.carson', name: 'Rachel Carson', discipline: 'Environmental Science' },
        ];
        facultySelect.innerHTML = '<option value="">-- Select a.Faculty --</option>';
        sampleFaculty.forEach(f => {
          const option = document.createElement('option');
          option.value = f.id;
          option.textContent = `${f.name} (${f.discipline})`;
          option.title = f.discipline;
          option.dataset.discipline = f.discipline;
          facultySelect.appendChild(option);
        });
      }
    }

    // Handle faculty selection change
    facultySelect.addEventListener('change', async (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      if (selectedOption.value) {
        const facultyId = selectedOption.value;
        const facultyName = selectedOption.textContent.split(' (')[0];
        const discipline = selectedOption.dataset.discipline || '';
        await updateFacultyPortrait(facultyId, facultyName, discipline);
      } else {
        if (facultyPortrait) {
          facultyPortrait.classList.add('hidden');
        }
      }
    });

    // Load course transcript - supports multiple videos
    async function loadCourse(courseId) {
      try {
        // First, load course metadata to get list of videos
        const metadataResponse = await fetch(`/data/metadata/${courseId}.json`);
        let courseMetadata = null;
        if (metadataResponse.ok) {
          courseMetadata = await metadataResponse.json();
          console.log('Loaded course metadata:', courseMetadata);
        }
        
        // If course has multiple videos, load all of them
        if (courseMetadata && courseMetadata.videos && courseMetadata.videos.length > 0) {
          const allSegments = [];
          let segmentIdCounter = 1;
          
          for (const video of courseMetadata.videos) {
            try {
              // Try to load transcript for this video
              // Try multiple naming patterns: video_id_dialogic_transcript.json, youtube_id_dialogic_transcript.json, or sample_dialogic_transcript.json for first video
              const videoId = video.video_id || video.youtube_id;
              let transcriptResponse = null;
              let transcriptId = null;
              
              // Try different file name patterns
              const possibleNames = [
                `${videoId}_dialogic_transcript.json`,
                `sample-video-${video.order}_dialogic_transcript.json`,
                video.order === 1 ? 'sample_dialogic_transcript.json' : null
              ].filter(Boolean);
              
              for (const fileName of possibleNames) {
                transcriptResponse = await fetch(`/data/transcripts/processed/${fileName}`);
                if (transcriptResponse.ok) {
                  transcriptId = fileName;
                  break;
                }
              }
              
              if (transcriptResponse && transcriptResponse.ok) {
                const videoTranscript = await transcriptResponse.json();
                console.log(`Loaded transcript for video ${video.order}: ${video.title} (${transcriptId})`, videoTranscript.segments?.length || 0, 'segments');
                
                // Add video title as a transition marker if not first video
                if (allSegments.length > 0 && videoTranscript.segments && videoTranscript.segments.length > 0) {
                  allSegments.push({
                    segment_id: segmentIdCounter++,
                    text: `Now let's move on to: ${video.title}`,
                    allows_questions: true,
                    pause_duration: 2000,
                    topic_marker: `video-${video.order}`,
                    is_transition: true
                  });
                }
                
                // Add all segments from this video, renumbering segment_ids
                if (videoTranscript.segments) {
                  videoTranscript.segments.forEach(segment => {
                    allSegments.push({
                      ...segment,
                      segment_id: segmentIdCounter++,
                      video_order: video.order,
                      video_title: video.title
                    });
                  });
                }
              } else {
                console.warn(`No transcript found for video ${video.order}: ${video.title}`);
              }
            } catch (videoError) {
              console.error(`Error loading transcript for video ${video.order}:`, videoError);
            }
          }
          
          if (allSegments.length > 0) {
            transcriptSegments = allSegments;
            console.log(`Loaded ${allSegments.length} total segments from ${courseMetadata.videos.length} videos`);
            return { segments: allSegments, metadata: courseMetadata };
          }
        }
        
        // Fallback: try single transcript file (for backward compatibility)
        const response = await fetch(`/data/transcripts/processed/sample_dialogic_transcript.json`);
        if (!response.ok) throw new Error('Failed to load transcript');
        
        const transcript = await response.json();
        transcriptSegments = transcript.segments || [];
        console.log('Loaded single transcript file:', transcriptSegments.length, 'segments');
        return transcript;
      } catch (error) {
        console.error('Failed to load course:', error);
        // Use embedded sample
        transcriptSegments = [
          {
            segment_id: 1,
            text: "Welcome to algebra. Today we'll explore the fundamental concepts of variables and how they work.",
            allows_questions: true,
            pause_duration: 2000
          },
          {
            segment_id: 2,
            text: "A variable is a symbol, usually a letter, that represents a number we don't know yet.",
            allows_questions: true,
            pause_duration: 1500
          }
        ];
        return { segments: transcriptSegments };
      }
    }

    // Message reactions storage
    const messageReactions = new Map(); // messageId -> { emoji: count }
    let replyingToMessageId = null;

    // Add message to chat
    function addMessage(type, text, sender = null, replyToId = null, messageId = null) {
      // Use provided messageId or generate one
      if (!messageId) {
        messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      }
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex gap-3 ${type === 'user' ? 'flex-row-reverse' : ''} message-item group`;
      messageDiv.dataset.messageId = messageId;
      messageDiv.dataset.type = type;
      
      // Use portrait/bust for faculty, always use image
      const avatar = document.createElement('img');
      if (type === 'faculty' && sender) {
        avatar.className = 'w-10 h-10 rounded-lg object-cover border-2 border-amber-500 flex-shrink-0';
        // Get portrait URL (async, but we'll set it)
        getPortraitUrl(sender).then(url => {
          avatar.src = url;
        }).catch(() => {
          // Fallback on error
          avatar.src = 'https://inquiry.institute/inquisitors/portraits/a-plato.jpg';
        });
        avatar.alt = `${sender} portrait`;
        avatar.onerror = function() {
          // Always use portrait, even if it fails - just use default
          this.src = 'https://inquiry.institute/inquisitors/portraits/a-plato.jpg';
        };
      } else {
        // User avatar - use a default portrait
        avatar.className = 'w-10 h-10 rounded-lg object-cover border-2 border-slate-500 flex-shrink-0';
        avatar.src = 'https://inquiry.institute/inquisitors/portraits/a-plato.jpg';
        avatar.alt = 'You';
      }
      
      const content = document.createElement('div');
      content.className = `flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-lg p-4 max-w-[80%] relative ${
        type === 'user' ? 'bg-amber-50 dark:bg-amber-900/20' : ''
      }`;
      
      // Reply indicator if replying to a message
      if (replyToId) {
        const replyIndicator = document.createElement('div');
        replyIndicator.className = 'text-xs text-slate-500 mb-2 pb-2 border-b border-slate-200 dark:border-slate-700';
        const replyToMsg = document.querySelector(`[data-message-id="${replyToId}"]`);
        if (replyToMsg) {
          const replyText = replyToMsg.querySelector('.message-text')?.textContent || '';
          replyIndicator.textContent = `â†© Replying to: ${replyText.substring(0, 50)}${replyText.length > 50 ? '...' : ''}`;
        }
        content.appendChild(replyIndicator);
      }
      
      const header = document.createElement('div');
      header.className = 'flex justify-between items-center mb-1';
      
      const senderSpan = document.createElement('span');
      senderSpan.className = 'text-sm font-semibold';
      senderSpan.textContent = sender || (type === 'faculty' ? 'a.Faculty' : 'You');
      
      const timeSpan = document.createElement('span');
      timeSpan.className = 'text-xs text-slate-500';
      timeSpan.textContent = new Date().toLocaleTimeString();
      
      header.appendChild(senderSpan);
      header.appendChild(timeSpan);
      
      const textDiv = document.createElement('div');
      textDiv.className = 'text-slate-900 dark:text-slate-100 message-text';
      textDiv.textContent = text;
      
      content.appendChild(header);
      content.appendChild(textDiv);
      
      // Emoji reactions bar
      const reactionsBar = document.createElement('div');
      reactionsBar.className = 'flex flex-wrap gap-1 mt-2 pt-2 border-t border-slate-200 dark:border-slate-700';
      reactionsBar.id = `reactions-${messageId}`;
      
      // Quick reaction buttons
      const quickReactions = document.createElement('div');
      quickReactions.className = 'flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity';
      const reactionEmojis = ['ðŸ’¡', 'ðŸ¤”', 'ðŸ‘', 'â¤ï¸', 'ðŸŽ¯', 'â“'];
      reactionEmojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'px-2 py-1 text-sm hover:bg-slate-200 dark:hover:bg-slate-700 rounded transition-colors';
        btn.textContent = emoji;
        btn.title = `React with ${emoji}`;
        btn.onclick = (e) => {
          e.stopPropagation();
          toggleReaction(messageId, emoji);
        };
        quickReactions.appendChild(btn);
      });
      
      // Reply button
      const replyBtn = document.createElement('button');
      replyBtn.className = 'px-2 py-1 text-xs text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity';
      replyBtn.textContent = 'â†© Reply';
      replyBtn.onclick = (e) => {
        e.stopPropagation();
        setReplyingTo(messageId);
      };
      quickReactions.appendChild(replyBtn);
      
      reactionsBar.appendChild(quickReactions);
      content.appendChild(reactionsBar);
      
      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
      
      return messageDiv; // Return for potential removal
    }

    // Toggle emoji reaction
    function toggleReaction(messageId, emoji) {
      if (!messageReactions.has(messageId)) {
        messageReactions.set(messageId, new Map());
      }
      const reactions = messageReactions.get(messageId);
      
      if (reactions.has(emoji)) {
        reactions.delete(emoji);
      } else {
        reactions.set(emoji, 1);
      }
      
      updateReactionsDisplay(messageId);
    }

    // Update reactions display
    function updateReactionsDisplay(messageId) {
      const reactionsBar = document.getElementById(`reactions-${messageId}`);
      if (!reactionsBar) return;
      
      const reactions = messageReactions.get(messageId) || new Map();
      const existingReactions = reactionsBar.querySelector('.reaction-badges');
      
      if (existingReactions) {
        existingReactions.remove();
      }
      
      if (reactions.size > 0) {
        const badges = document.createElement('div');
        badges.className = 'flex flex-wrap gap-1 reaction-badges';
        
        reactions.forEach((count, emoji) => {
          const badge = document.createElement('button');
          badge.className = 'px-2 py-0.5 text-xs bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors';
          badge.textContent = `${emoji} ${count}`;
          badge.onclick = (e) => {
            e.stopPropagation();
            toggleReaction(messageId, emoji);
          };
          badges.appendChild(badge);
        });
        
        reactionsBar.insertBefore(badges, reactionsBar.firstChild);
      }
    }

    // Set replying to message
    function setReplyingTo(messageId) {
      replyingToMessageId = messageId;
      const replyToMsg = document.querySelector(`[data-message-id="${messageId}"]`);
      const replyIndicator = document.getElementById('replyIndicator');
      const replyText = document.getElementById('replyText');
      
      if (replyToMsg && replyIndicator && replyText) {
        replyToMsg.classList.add('ring-2', 'ring-amber-500');
        const msgText = replyToMsg.querySelector('.message-text')?.textContent || '';
        replyText.textContent = msgText.substring(0, 60) + (msgText.length > 60 ? '...' : '');
        replyIndicator.classList.remove('hidden');
        chatInput.focus();
      }
    }

    // Clear reply
    function clearReply() {
      if (replyingToMessageId) {
        const replyToMsg = document.querySelector(`[data-message-id="${replyingToMessageId}"]`);
        if (replyToMsg) {
          replyToMsg.classList.remove('ring-2', 'ring-amber-500');
        }
      }
      replyingToMessageId = null;
      const replyIndicator = document.getElementById('replyIndicator');
      if (replyIndicator) {
        replyIndicator.classList.add('hidden');
      }
      chatInput.placeholder = 'Ask a question or type a message...';
    }

    // Generate contextual answer when API fails
    function generateContextualAnswer(question, context) {
      const lowerQuestion = question.toLowerCase();
      
      // Check for common question patterns and provide helpful responses
      if (lowerQuestion.includes('variable') && (lowerQuestion.includes('not') || lowerQuestion.includes('no longer'))) {
        return `That's an excellent observation! You're absolutely right to question this. When we assign a specific value like 5 to x, we're creating an equation where x has a definite value. However, x is still called a "variable" because in the general form of the equation, it can take different values. The term "variable" refers to the symbol's role in the equation structure, not whether it currently has a fixed value. Would you like me to explore this distinction further?`;
      }
      
      if (lowerQuestion.includes('why') || lowerQuestion.includes('how')) {
        return `That's a thoughtful question about ${context || 'this topic'}. Let me think through this carefully. The key insight here is that ${context ? 'in this context, ' : ''}we need to consider multiple perspectives. Would you like me to elaborate on a specific aspect?`;
      }
      
      if (lowerQuestion.includes('what') || lowerQuestion.includes('explain')) {
        return `I appreciate you asking for clarification. ${context ? `In the context of ${context}, ` : ''}this concept involves several important ideas. Let me break this down step by step so we can explore it together.`;
      }
      
      // Generic but helpful response
      return `That's a great question! ${context ? `In the context of ${context}, ` : ''}this is an important point to understand. Let me explain this more clearly so we can explore it together.`;
    }

    // Make clearReply available globally for onclick
    window.clearReply = clearReply;

    // Start delivery
    async function startDelivery() {
      const courseId = courseSelect.value;
      const facultyId = facultySelect.value;
      const roomAlias = matrixRoomInput.value.trim();

      if (!courseId || !facultyId) {
        alert('Please select both a course and a.Faculty');
        return;
      }

      currentCourse = courseId;
      currentFaculty = facultyId;
      
      // Load transcript
      await loadCourse(courseId);
      
      // Initialize dialogic
      const { Dialogic: DialogicClass } = await loadDialogic();
      dialogic = new DialogicClass({
        matrixServer: 'https://matrix.inquiry.institute',
        apiUrl: 'https://xougqdomkoisrxdnagcj.supabase.co/functions/v1',
        apiKey: SUPABASE_ANON_KEY,
        defaultPauseDuration: 2000
      });

      // Log transcript info for debugging
      console.log('Loading transcript with', transcriptSegments.length, 'segments');
      console.log('Transcript segments:', transcriptSegments);

      await dialogic.initialize(
        roomAlias || null,
        transcriptSegments,
        facultyId
      );

      // Verify delivery engine has segments
      if (dialogic.deliveryEngine) {
        console.log('Delivery engine initialized with', dialogic.deliveryEngine.segments?.length || 0, 'segments');
      }

      // Set up callbacks BEFORE starting
      dialogic.onSegment((segment, index, total) => {
        console.log(`Delivering segment ${index + 1}/${total}:`, segment.text?.substring(0, 50));
        addMessage('faculty', segment.text, facultyId);
        const progress = ((index + 1) / total) * 100;
        progressFill.style.width = `${progress}%`;
      });

      dialogic.onComplete(() => {
        console.log('Delivery completed!');
        statusBadge.textContent = 'Complete';
        statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400';
        addMessage('system', 'Delivery complete!');
      });

      dialogic.onQuestionResponse((question, answer) => {
        addMessage('faculty', answer, facultyId);
      });

      // Update UI
      statusBadge.textContent = roomAlias ? 'Connected' : 'Local Mode';
      statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400';
      progressBar.classList.remove('hidden');
      chatInput.disabled = false;
      sendBtn.disabled = false;

      addMessage('system', `Starting delivery of "${courseSelect.options[courseSelect.selectedIndex].text}" by ${facultySelect.options[facultySelect.selectedIndex].text} (${transcriptSegments.length} segments)`);
      
      // Start delivery
      console.log('Starting delivery...');
      await dialogic.start();
      console.log('Delivery started');
    }

    // Handle send - use direct API call for better control
    sendBtn.addEventListener('click', async () => {
      const question = chatInput.value.trim();
      if (question && dialogic && currentFaculty) {
        const userMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        // Add user message with reply indicator if needed
        addMessage('user', question, null, replyingToMessageId, userMessageId);
        
        chatInput.value = '';
        clearReply();
        chatInput.disabled = true;
        sendBtn.disabled = true;
        
        // Show typing indicator
        const typingMsg = addMessage('faculty', '...', currentFaculty);
        
        try {
          // Get current course context
          const courseTitle = courseSelect.options[courseSelect.selectedIndex]?.text || '';
          const currentSegment = transcriptSegments[dialogic.deliveryEngine?.currentIndex - 1];
          const lessonContext = currentSegment?.topic_marker || currentSegment?.text?.substring(0, 100) || courseTitle;
          
          // Pause delivery
          if (dialogic.deliveryEngine) {
            dialogic.deliveryEngine.pause();
          }
          
          // Try ask-faculty endpoint directly (most reliable for actual answers)
          let response = null;
          let answer = null;
          
          // Try ask-faculty endpoint first - use correct format
          try {
            const apiResponse = await fetch('https://xougqdomkoisrxdnagcj.supabase.co/functions/v1/ask-faculty', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
              },
              body: JSON.stringify({
                faculty_id: currentFaculty,
                message: question,  // Use 'message' not 'question'
                conversation_history: [],
                context: 'office_hours'  // Use office_hours context for Q&A
              })
            });

            if (apiResponse.ok) {
              const data = await apiResponse.json();
              answer = data.response || data.answer || data.reply;
              console.log('ask-faculty response:', data);
              
              // Check if we got a real answer (not generic fallback)
              if (answer && answer.trim() && 
                  !answer.includes('Thank you for that question') &&
                  !answer.includes('Let me continue with the lesson')) {
                response = { answer, source: 'ask-faculty' };
              } else {
                console.warn('Got generic response from ask-faculty:', answer);
              }
            } else {
              const errorText = await apiResponse.text();
              console.warn('ask-faculty error:', apiResponse.status, errorText);
            }
          } catch (err) {
            console.warn('ask-faculty failed:', err);
          }
          
          // Fallback to faculty-chat if ask-faculty didn't work
          if (!response || !answer || answer.includes('Thank you for that question')) {
            try {
              const { DialogicAPI: API } = await loadDialogic();
              const api = new API({
                apiUrl: 'https://xougqdomkoisrxdnagcj.supabase.co/functions/v1',
                apiKey: SUPABASE_ANON_KEY
              });
              
              response = await api.askFaculty(currentFaculty, question, {
                context: lessonContext,
                conversationHistory: []
              });
              answer = response.answer;
            } catch (err) {
              console.error('Dialogic API failed:', err);
            }
          }
          
          // Remove typing indicator
          if (typingMsg && typingMsg.parentNode) {
            typingMsg.parentNode.removeChild(typingMsg);
          }
          
          // Add the actual response as a reply to the user's question
          if (answer && answer.trim() && !answer.includes('Thank you for that question')) {
            addMessage('faculty', answer, currentFaculty, userMessageId);
          } else {
            // Generate a contextual response based on the question
            // This is a better fallback that actually addresses the question
            const contextualAnswer = generateContextualAnswer(question, lessonContext);
            addMessage('faculty', contextualAnswer, currentFaculty, userMessageId);
          }
          
          // Log the source for debugging
          console.log('Response source:', response?.source || 'generated');
          console.log('Current delivery state:', {
            isDelivering: dialogic.deliveryEngine?.isDelivering,
            isPaused: dialogic.deliveryEngine?.isPaused,
            currentIndex: dialogic.deliveryEngine?.currentIndex,
            totalSegments: dialogic.deliveryEngine?.segments?.length
          });
          
          // Resume delivery after delay
          if (dialogic.deliveryEngine) {
            const delay = response?.source === 'fallback' || response?.source === 'contextual-fallback' ? 3000 : 2000;
            console.log(`Resuming delivery in ${delay}ms...`);
            setTimeout(() => {
              if (dialogic.deliveryEngine) {
                console.log('Attempting to resume delivery...');
                dialogic.deliveryEngine.resume();
              }
            }, delay);
          }
        } catch (error) {
          console.error('Error handling question:', error);
          // Remove typing indicator
          if (typingMsg && typingMsg.parentNode) {
            typingMsg.parentNode.removeChild(typingMsg);
          }
          addMessage('faculty', 'I apologize, but I encountered an error processing your question. Please try asking again.', currentFaculty, userMessageId);
          
          // Resume delivery
          if (dialogic.deliveryEngine) {
            setTimeout(() => {
              dialogic.deliveryEngine.resume();
            }, 2000);
          }
        } finally {
          chatInput.disabled = false;
          sendBtn.disabled = false;
        }
      }
    });

    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Update start button
    function updateStartButton() {
      startBtn.disabled = !(courseSelect.value && facultySelect.value);
    }

    courseSelect.addEventListener('change', updateStartButton);
    facultySelect.addEventListener('change', updateStartButton);
    startBtn.addEventListener('click', startDelivery);

    // Initialize
    loadFaculty();
    updateStartButton();
  </script>
</BaseLayout>
